# ============================================
# DOCKER COMPOSE - APIDIAN PHP 7.3 OPTIMIZADO
# Compatible con DIAN Colombia - Máximo Rendimiento
# ============================================
version: '3.8'

services:
    nginx:
        build:
            context: ./docker/nginx
            dockerfile: Dockerfile
        container_name: apidian_nginx
        working_dir: /var/www/html
        ports:
            - "${HTTP_PORT:-80}:80"
            - "${HTTPS_PORT:-443}:443"
        volumes:
            - ./:/var/www/html:cached
            - ./docker/nginx/sites-available:/etc/nginx/conf.d
            - nginx_cache:/var/cache/nginx
            - nginx_logs:/var/log/nginx
            # SSL volumes (solo se usan si SSL está habilitado)
            - /etc/letsencrypt:/etc/letsencrypt:ro
            - /var/www/certbot:/var/www/certbot
        depends_on:
            - php
        networks:
            - api_dian
        restart: unless-stopped
        deploy:
            resources:
                limits:
                    memory: 256M
                    cpus: '0.5'
                reservations:
                    memory: 128M
                    cpus: '0.25'
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

    # Servicio Certbot para SSL (se ejecuta bajo demanda)
    certbot:
        image: certbot/certbot
        container_name: apidian_certbot
        volumes:
            - /etc/letsencrypt:/etc/letsencrypt
            - /var/www/certbot:/var/www/certbot
        profiles:
            - ssl
        networks:
            - api_dian

    php:
        build:
            context: ./docker/php
            dockerfile: Dockerfile
        container_name: apidian_php
        working_dir: /var/www/html
        volumes:
            - ./:/var/www/html:cached
            - php_sessions:/tmp
            - composer_cache:/root/.composer
        depends_on:
            - mariadb
            - redis
        networks:
            - api_dian
        environment:
            # PHP Optimizations
            - PHP_OPCACHE_ENABLE=1
            - PHP_OPCACHE_VALIDATE_TIMESTAMPS=0
            - PHP_OPCACHE_REVALIDATE_FREQ=0
            - PHP_OPCACHE_MAX_ACCELERATED_FILES=20000
            - PHP_OPCACHE_MEMORY_CONSUMPTION=512
            - PHP_REALPATH_CACHE_SIZE=4096K
            - PHP_REALPATH_CACHE_TTL=600
            # Laravel Environment
            - APP_ENV=production
            - APP_DEBUG=false
            - DB_HOST=mariadb
            - DB_PORT=3306
            - CACHE_DRIVER=redis
            - SESSION_DRIVER=redis
            - REDIS_HOST=redis
            - REDIS_PORT=6379
        restart: unless-stopped
        deploy:
            resources:
                limits:
                    memory: 1024M
                    cpus: '1.0'
                reservations:
                    memory: 512M
                    cpus: '0.5'
        healthcheck:
            test: ["CMD", "php", "-v"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

    mariadb:
        image: mariadb:10.3
        container_name: apidian_mariadb
        environment:
            - MYSQL_USER=${MYSQL_USER:-apidian}
            - MYSQL_PASSWORD=${MYSQL_PASSWORD}
            - MYSQL_DATABASE=${MYSQL_DATABASE:-apidian}
            - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
            - MYSQL_INITDB_SKIP_TZINFO=1
        ports:
            - "${MYSQL_PORT:-3306}:3306"
        volumes:
            - apidian_mysql_data:/var/lib/mysql
            - ./docker/mariadb/my.cnf:/etc/mysql/conf.d/custom.cnf:ro
            - mysql_logs:/var/log/mysql
        networks:
            - api_dian
        command: >
            --innodb-buffer-pool-size=512M
            --innodb-log-file-size=128M
            --innodb-log-buffer-size=32M
            --innodb-flush-log-at-trx-commit=2
            --innodb-flush-method=O_DIRECT
            --innodb-file-per-table=1
            --character-set-server=utf8
            --collation-server=utf8_spanish_ci
            --max-connections=200
            --query-cache-type=1
            --query-cache-size=64M
            --tmp-table-size=64M
            --max-heap-table-size=64M
            --thread-cache-size=50
            --table-open-cache=4000
            --key-buffer-size=256M
            --sort-buffer-size=4M
            --read-buffer-size=2M
            --join-buffer-size=8M
            --skip-name-resolve
            --skip-external-locking
            --max-allowed-packet=64M
        restart: unless-stopped
        deploy:
            resources:
                limits:
                    memory: 1024M
                    cpus: '1.0'
                reservations:
                    memory: 512M
                    cpus: '0.5'
        healthcheck:
            test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
            interval: 30s
            timeout: 10s
            retries: 5
            start_period: 60s

    redis:
        image: redis:7-alpine
        container_name: apidian_redis
        command: >
            redis-server
            --appendonly yes
            --maxmemory 256mb
            --maxmemory-policy allkeys-lru
            --save 60 1000
            --tcp-keepalive 60
            --timeout 300
            --databases 16
        volumes:
            - redis_data:/data
        networks:
            - api_dian
        restart: unless-stopped
        deploy:
            resources:
                limits:
                    memory: 256M
                    cpus: '0.25'
                reservations:
                    memory: 128M
                    cpus: '0.1'
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 30s

networks:
    api_dian:
        driver: bridge
        driver_opts:
            com.docker.network.driver.mtu: 1500
        ipam:
            config:
                - subnet: 172.20.0.0/16

volumes:
    apidian_mysql_data:
        driver: local
    redis_data:
        driver: local
    nginx_cache:
        driver: local
    nginx_logs:
        driver: local
    mysql_logs:
        driver: local
    php_sessions:
        driver: local
    composer_cache:
        driver: local
